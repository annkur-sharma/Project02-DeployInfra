trigger:
  branches:
    include:
      - main
      - feature/*

pool:
  vmImage: 'ubuntu-latest'
  # name: 'AgentPool-09NOV2025'

parameters:
  - name: environment
    displayName: ENVIRONMENT
    type: string
    default: dev
    values:
      - dev
      - staging

variables:
- name: varServiceConnection
  value: ServiceConnection-09NOV2025

- name: varbackendAzureRmResourceGroupName
  value: ankurbackend01

- name: varbackendAzureRmStorageAccountName
  value: ankur01storage01ac01

# Selected values based on parameter: dev or staging
- name: selected_service_connection
  value: ${{ variables.varServiceConnection }}

- ${{ if eq(parameters.environment, 'dev') }}:
  - group: Project02-VariableGroup-Dev
  - name: varWorkingDirectory
    value: '$(System.DefaultWorkingDirectory)/infra/dev'

- ${{ if eq(parameters.environment, 'staging') }}:
  - group: Project02-VariableGroup-Staging
  - name: varWorkingDirectory
    value: '$(System.DefaultWorkingDirectory)/infra/staging'


stages:
# =====================================
# Main branch flow
# =====================================
# Stage: terraform install > terraform init
- stage: MainBranchMerge_TerraformInit
  displayName: "Branch: (main) - Stage: Terraform Init"
  condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')
  jobs:
  - job: Main_Init
    steps:
    # Terraform INSTALL
    - task: TerraformInstaller@1
      displayName: 'Task: terraform install'
      inputs:
        terraformVersion: 'latest'
        
    # Terraform INIT
    - task: TerraformTaskV4@4
      displayName: 'Task: terraform init'
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: ${{ variables.varWorkingDirectory }}
        backendServiceArm: '$(selected_service_connection)'
        backendAzureRmResourceGroupName: '$(varbackendAzureRmResourceGroupName)'
        backendAzureRmStorageAccountName: '$(varbackendAzureRmStorageAccountName)'
        backendAzureRmContainerName: '$(selectedVG_varbackendAzureRmContainerName)'
        backendAzureRmKey: '$(selectedVG_varbackendAzureRmKey)'

# Stage: Manual Validation > terraform install > terraform init > terraform plan
- stage: MainBranchMerge_Approval
  displayName: "Branch: (main) - Stage: Approval"
  dependsOn: MainBranchMerge_TerraformInit
  condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')
  jobs:
  - job: Main_Approval_Init_Plan
    pool: server   # ✅ REQUIRED for ManualValidation
    steps:
    # Manual Validation
    - task: ManualValidation@0
      inputs:
        notifyUsers: 'ankur@example.com'
        instructions: 'Approve to proceed with Terraform Plan for main branch.'

# Stage: Manual Validation > terraform install > terraform init > terraform plan
- stage: MainBranchMerge_TerraformInitPlan
  displayName: "Branch: (main) - Stage: Init, Plan"
  dependsOn: MainBranchMerge_TerraformInit
  condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')
  jobs:
  - job: Main_Init_Plan
    steps:
    # Terraform INSTALL
    - task: TerraformInstaller@1
      displayName: 'Task: terraform install'
      inputs:
        terraformVersion: 'latest'
        
    # Terraform INIT
    - task: TerraformTaskV4@4
      displayName: 'Task: terraform init'
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: ${{ variables.varWorkingDirectory }}
        backendServiceArm: '$(selected_service_connection)'
        backendAzureRmResourceGroupName: '$(varbackendAzureRmResourceGroupName)'
        backendAzureRmStorageAccountName: '$(varbackendAzureRmStorageAccountName)'
        backendAzureRmContainerName: '$(selectedVG_varbackendAzureRmContainerName)'
        backendAzureRmKey: '$(selectedVG_varbackendAzureRmKey)'

    # Terraform PLAN
    - task: TerraformTaskV4@4
      displayName: 'Task: terraform plan'
      inputs:
        provider: 'azurerm'
        command: 'plan'
        workingDirectory: ${{ variables.varWorkingDirectory }}
        environmentServiceNameAzureRM: '$(selected_service_connection)'

# =====================================
# Feature branch flow
# =====================================

# Stage: terraform install > terraform init
- stage: FeatureBranchMerge_TerraformInit
  displayName: "Stage: Terraform Init"
  condition: startsWith(variables['Build.SourceBranch'], 'refs/heads/feature/')
  jobs:
  - job: Feature_Init
    steps:
    # Terraform INSTALL
    - task: TerraformInstaller@1
      displayName: 'Task: terraform install'
      inputs:
        terraformVersion: 'latest'

    # Terraform INIT
    - task: TerraformTaskV4@4
      displayName: 'Task: terraform init'
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: ${{ variables.varWorkingDirectory }}
        backendServiceArm: '$(selected_service_connection)'
        backendAzureRmResourceGroupName: '$(varbackendAzureRmResourceGroupName)'
        backendAzureRmStorageAccountName: '$(varbackendAzureRmStorageAccountName)'
        backendAzureRmContainerName: '$(selectedVG_varbackendAzureRmContainerName)'
        backendAzureRmKey: '$(selectedVG_varbackendAzureRmKey)'

# Stage: terraform install > terraform init > terraform validate
- stage: FeatureBranchMerge_TerraformValidate
  displayName: "Stage: Terraform Validate"
  dependsOn: FeatureBranchMerge_TerraformInit
  condition: startsWith(variables['Build.SourceBranch'], 'refs/heads/feature/')
  jobs:
  - job: Feature_Init_Validate
    steps:

    # Terraform INSTALL
    - task: TerraformInstaller@1
      displayName: 'Task: terraform install'
      inputs:
        terraformVersion: 'latest'

    # Terraform INIT
    - task: TerraformTaskV4@4
      displayName: 'Task: terraform init'
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: ${{ variables.varWorkingDirectory }}
        backendServiceArm: '$(selected_service_connection)'
        backendAzureRmResourceGroupName: '$(varbackendAzureRmResourceGroupName)'
        backendAzureRmStorageAccountName: '$(varbackendAzureRmStorageAccountName)'
        backendAzureRmContainerName: '$(selectedVG_varbackendAzureRmContainerName)'
        backendAzureRmKey: '$(selectedVG_varbackendAzureRmKey)'

    # Terraform VALIDATE
    - task: TerraformTaskV4@4
      displayName: 'Task: terraform validate'
      inputs:
        provider: 'azurerm'
        command: 'validate'
        workingDirectory: ${{ variables.varWorkingDirectory }}

- stage: TerraformLintAndSecurity
  displayName: "Stage: TFLint and TFsec Scan"
  dependsOn: FeatureBranchMerge_TerraformValidate
  condition: startsWith(variables['Build.SourceBranch'], 'refs/heads/feature/')
  jobs:
  - job: LintAndSecurity
    displayName: "Run TFLint and TFsec"
    pool:
      vmImage: 'ubuntu-latest'
    steps:

    # Checkout code
    - checkout: self

    # Install TFLint
    - script: |
        echo "Installing TFLint..."
        curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
        tflint --version
      displayName: "Install TFLint"

    # Run TFLint
    - script: |
        echo "Running TFLint..."
        cd ${{ variables.varWorkingDirectory }}
        tflint --init
        tflint --enable-rule=terraform_required_providers
      displayName: "Run TFLint Analysis"

    - script: |
        tflint --format json > tflint-report.json || true
      displayName: "Generate Scan Reports"

    - publish: tflint-report.json
      artifact: TFLintReport

    # Install TFsec
    - script: |
        echo "Installing TFsec..."
        curl -sSL https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
        tfsec --version
      displayName: "Install TFsec"

    # Run TFsec
    - script: |
        echo "Running TFsec security scan..."
        cd ${{ variables.varWorkingDirectory }}
        tfsec .
      displayName: "Run TFsec Scan"

    - script: |
        tfsec . --format json > tfsec-report.json || true
      displayName: "Generate Scan Reports"

    - publish: tfsec-report.json
      artifact: TFsecReport

- stage: FeatureBranchMerge_Approval
  displayName: "Stage: Approval before Fmt (feature)"
  dependsOn: FeatureBranchMerge_TerraformValidate
  condition: startsWith(variables['Build.SourceBranch'], 'refs/heads/feature/')
  jobs:
  - job: Feature_Approval
    pool: server   # ✅ REQUIRED for ManualValidation
    steps:
    - task: ManualValidation@0
      inputs:
        notifyUsers: 'ankur@example.com'
        instructions: 'Approve to run Terraform Fmt on feature branch.'

# Stage: terraform install > terraform init > terraform fmt
- stage: FeatureBranchMerge_TerraformFmt
  displayName: "Stage: Terraform Fmt"
  dependsOn: FeatureBranchMerge_Approval
  condition: startsWith(variables['Build.SourceBranch'], 'refs/heads/feature/')
  jobs:
  - job: Feature_Init_Fmt
    steps:
    # Terraform INSTALL
    - task: TerraformInstaller@1
      displayName: 'Task: terraform install'
      inputs:
        terraformVersion: 'latest'

    # Terraform INIT
    - task: TerraformTaskV4@4
      displayName: 'Task: terraform init'
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: ${{ variables.varWorkingDirectory }}
        backendServiceArm: '$(selected_service_connection)'
        backendAzureRmResourceGroupName: '$(varbackendAzureRmResourceGroupName)'
        backendAzureRmStorageAccountName: '$(varbackendAzureRmStorageAccountName)'
        backendAzureRmContainerName: '$(selectedVG_varbackendAzureRmContainerName)'
        backendAzureRmKey: '$(selectedVG_varbackendAzureRmKey)'

    # Terraform FMT
    - task: TerraformTaskV4@4
      displayName: 'Task: terraform fmt'
      inputs:
        provider: 'azurerm'
        command: 'custom'
        customCommand: 'fmt'
        workingDirectory: ${{ variables.varWorkingDirectory }}
        environmentServiceNameAzureRM: '$(selected_service_connection)'

